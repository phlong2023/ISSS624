{
  "hash": "f2cd12bf267cb4e93b8e56d06bc44a25",
  "result": {
    "markdown": "---\ntitle: \"In-class Exercise 5\"\ndate: '16 December 2023'\ndate-modified: 'last-modified'\nformat: html\nexecute: \n  eval: true # run the code live\n  echo: true # all code will appear\n  warning: false # hide all warnings\neditor: visual\n---\n\n\n## Getting Started\n\nBecause spflow is too new, the version on CRAN might not be the most updated version. Therefore, we can get it directly from the developer's github using the **devtools** package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndevtools::install_github('LukeCe/spflow')\n```\n:::\n\n\nNow, we can load it in as part of our required packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tmap, sf, spdep, sp, Matrix, spflow, reshape2, knitr, tidyverse)\n```\n:::\n\n\n## Data Preparation\n\nTo work with **spflow,** we require:\n\n1.  Spatial Weights\n2.  A O-D, flow, distance between the origin and destination in the form of a tibble df\n3.  A tibble df of explanatory variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz <- st_read(dsn = 'data/geospatial',\n                layer = 'MPSZ-2019') %>%\n  st_transform(crs = 3414)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `MPSZ-2019' from data source \n  `D:\\phlong2023\\ISSS624\\In-Class_Ex\\In-Class_Ex5\\data\\geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 332 features and 6 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775\nGeodetic CRS:  WGS 84\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbusstop <- st_read(dsn = 'data/geospatial',\n                   layer = 'BusStop')%>%\n  st_transform(crs = 3414)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `BusStop' from data source \n  `D:\\phlong2023\\ISSS624\\In-Class_Ex\\In-Class_Ex5\\data\\geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 5159 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 3970.122 ymin: 26482.1 xmax: 48280.78 ymax: 52983.82\nProjected CRS: SVY21\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz$`BUSSTOP_COUNT` <- lengths(st_intersects(mpsz,busstop))\n```\n:::\n\n\nFilter planning subzones without bus stop.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_busstop <- mpsz %>%\n  filter(BUSSTOP_COUNT > 0)\nmpsz_busstop\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 313 features and 7 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 2667.538 ymin: 21448.47 xmax: 50271.73 ymax: 50256.33\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n            SUBZONE_N SUBZONE_C       PLN_AREA_N PLN_AREA_C       REGION_N\n1    INSTITUTION HILL    RVSZ05     RIVER VALLEY         RV CENTRAL REGION\n2      ROBERTSON QUAY    SRSZ01  SINGAPORE RIVER         SR CENTRAL REGION\n3        FORT CANNING    MUSZ02           MUSEUM         MU CENTRAL REGION\n4    MARINA EAST (MP)    MPSZ05    MARINE PARADE         MP CENTRAL REGION\n5             SENTOSA    SISZ01 SOUTHERN ISLANDS         SI CENTRAL REGION\n6      CITY TERMINALS    BMSZ17      BUKIT MERAH         BM CENTRAL REGION\n7               ANSON    DTSZ10    DOWNTOWN CORE         DT CENTRAL REGION\n8        STRAITS VIEW    SVSZ01     STRAITS VIEW         SV CENTRAL REGION\n9     MARITIME SQUARE    BMSZ01      BUKIT MERAH         BM CENTRAL REGION\n10 TELOK BLANGAH RISE    BMSZ15      BUKIT MERAH         BM CENTRAL REGION\n   REGION_C                       geometry BUSSTOP_COUNT\n1        CR MULTIPOLYGON (((28481.45 30...             2\n2        CR MULTIPOLYGON (((28087.34 30...            10\n3        CR MULTIPOLYGON (((29542.53 31...             6\n4        CR MULTIPOLYGON (((35279.55 30...             2\n5        CR MULTIPOLYGON (((26879.04 26...             1\n6        CR MULTIPOLYGON (((27891.15 28...            10\n7        CR MULTIPOLYGON (((29201.07 28...             5\n8        CR MULTIPOLYGON (((31269.21 28...             4\n9        CR MULTIPOLYGON (((26920.02 26...            21\n10       CR MULTIPOLYGON (((27483.57 28...            11\n```\n:::\n:::\n\n\n### Preparing the Spatial Weights\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncentroids <- suppressWarnings({\n  st_point_on_surface(st_geometry(mpsz_busstop))\n})\n\nmpsz_nb <- list(\n  'by_contiguity' = poly2nb(mpsz_busstop),\n  'by_distance' = dnearneigh(centroids, d1 = 0, d2 = 5000),\n  'by_knn' = knn2nb(knearneigh(centroids, 3))\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_nb\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$by_contiguity\nNeighbour list object:\nNumber of regions: 313 \nNumber of nonzero links: 1902 \nPercentage nonzero weights: 1.94143 \nAverage number of links: 6.076677 \n\n$by_distance\nNeighbour list object:\nNumber of regions: 313 \nNumber of nonzero links: 15422 \nPercentage nonzero weights: 15.74171 \nAverage number of links: 49.27157 \n1 region with no links:\n313\n\n$by_knn\nNeighbour list object:\nNumber of regions: 313 \nNumber of nonzero links: 939 \nPercentage nonzero weights: 0.9584665 \nAverage number of links: 3 \nNon-symmetric neighbours list\n```\n:::\n:::\n\n\n### Preparing the Flow Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nodbus6_9 <- read_rds('data/rds/odbus6_9.rds')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_nb <- read_rds('data/rds/mpsz_nb.rds')\nmpsz_flow <- read_rds('data/rds/mpsz_flow.rds')\nmpsz_var <- read_rds('data/rds/mpsz_var.rds')\n```\n:::\n\n\nFor our model, we choose the contiguity based neighborhood structure.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_net <- spflow_network(\n  id_net = 'sg',\n  node_neighborhood = \n    nb2mat(mpsz_nb$by_contiguity),\n  node_data = mpsz_var,\n  node_key_column = 'SZ_CODE'\n)\n\nmpsz_net\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSpatial network nodes with id: sg\n--------------------------------------------------\nNumber of nodes: 313\nAverage number of links per node: 6.077\nDensity of the neighborhood matrix: 1.94% (non-zero connections)\n\nData on nodes:\n                SZ_NAME SZ_CODE BUSSTOP_COUNT AGE7_12 AGE13_24 AGE25_64\n1      INSTITUTION HILL  RVSZ05             2     330      360     2260\n2        ROBERTSON QUAY  SRSZ01            10     320      350     2200\n3          FORT CANNING  MUSZ02             6       0       10       30\n4      MARINA EAST (MP)  MPSZ05             2       0        0        0\n5               SENTOSA  SISZ01             1     200      260     1440\n6        CITY TERMINALS  BMSZ17            10       0        0        0\n---                 ---     ---           ---     ---      ---      ---\n308            NEE SOON  YSSZ07            12      90      140      590\n309       UPPER THOMSON  BSSZ01            47    1590     3660    15980\n310          SHANGRI-LA  AMSZ05            12     810     1920     9650\n311          TOWNSVILLE  AMSZ04             9     980     2000    11320\n312           MARYMOUNT  BSSZ02            25    1610     4060    16860\n313 TUAS VIEW EXTENSION  TSSZ06            11       0        0        0\n    SCHOOL_COUNT BUSINESS_COUNT RETAILS_COUNT FINSERV_COUNT ENTERTN_COUNT\n1              1              6            26             3             0\n2              0              4           207            18             6\n3              0              7            17             0             3\n4              0              0             0             0             0\n5              0              1            84            29             2\n6              0             11            14             4             0\n---          ---            ---           ---           ---           ---\n308            0              0             7             0             0\n309            3             21           305            30             0\n310            3              0            53             9             0\n311            1              0            83            11             0\n312            3             19           135             8             0\n313            0             53             3             1             0\n    FB_COUNT LR_COUNT COORD_X COORD_Y\n1          4        3  103.84    1.29\n2         38       11  103.84    1.29\n3          4        7  103.85    1.29\n4          0        0  103.88    1.29\n5         38       20  103.83    1.25\n6         15        0  103.85    1.26\n---      ---      ---     ---     ---\n308        0        0  103.81     1.4\n309        5       11  103.83    1.36\n310        0        0  103.84    1.37\n311        1        1  103.85    1.36\n312        3       11  103.84    1.35\n313        0        0  103.61    1.26\n```\n:::\n:::\n\n\n### Preparing Network Pairs\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_net_pairs <- spflow_network_pair(\n  id_orig_net = 'sg',\n  id_dest_net = 'sg',\n  pair_data = mpsz_flow,\n  orig_key_column = 'ORIGIN_SZ',\n  dest_key_column = 'DESTIN_SZ'\n)\n\nmpsz_net_pairs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSpatial network pair with id: sg_sg\n--------------------------------------------------\nOrigin network id: sg (with 313 nodes)\nDestination network id: sg (with 313 nodes)\nNumber of pairs: 97969\nCompleteness of pairs: 100.00% (97969/97969)\n\nData on node-pairs:\n      DESTIN_SZ ORIGIN_SZ DISTANCE TRIPS\n1        RVSZ05    RVSZ05        0    67\n314      SRSZ01    RVSZ05   305.74   251\n627      MUSZ02    RVSZ05   951.83     0\n940      MPSZ05    RVSZ05  5254.07     0\n1253     SISZ01    RVSZ05     4975     0\n1566     BMSZ17    RVSZ05  3176.16     0\n---         ---       ---      ---   ---\n96404    YSSZ07    TSSZ06 26972.97     0\n96717    BSSZ01    TSSZ06 25582.48     0\n97030    AMSZ05    TSSZ06 26714.79     0\n97343    AMSZ04    TSSZ06 27572.74     0\n97656    BSSZ02    TSSZ06  26681.7     0\n97969    TSSZ06    TSSZ06        0   270\n```\n:::\n:::\n\n\n### Creating spflow_network_multi object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_multi_net <- spflow_network_multi(mpsz_net, mpsz_net_pairs)\n\nmpsz_multi_net\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCollection of spatial network nodes and pairs\n--------------------------------------------------\nContains 1 spatial network nodes  \n    With id :  sg\nContains 1 spatial network pairs  \n    With id :  sg_sg\n\nAvailability of origin-destination pair information:\n\n ID_ORIG_NET ID_DEST_NET ID_NET_PAIR COMPLETENESS     C_PAIRS  C_ORIG  C_DEST\n          sg          sg       sg_sg      100.00% 97969/97969 313/313 313/313\n```\n:::\n:::\n\n\n## Correlation Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor_formula <- log(1+TRIPS) ~ \n  BUSSTOP_COUNT +\n  AGE7_12 +\n  AGE13_24 +\n  AGE25_64 +\n  SCHOOL_COUNT +\n  BUSINESS_COUNT +\n  RETAILS_COUNT +\n  FINSERV_COUNT +\n  P_(log(DISTANCE + 1))\n\ncor_mat <- pair_cor(\n  mpsz_multi_net,\n  spflow_formula = cor_formula,\n  add_lags_x = FALSE\n)\n\ncolnames(cor_mat) <- paste0(substr(colnames(cor_mat),1,3),'...')\n\ncor_image(cor_mat)\n```\n\n::: {.cell-output-display}\n![](In-Class_Ex5_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## Model Calibrartion\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_model <- spflow(\n  spflow_formula = log(1+TRIPS) ~\n    O_(BUSSTOP_COUNT + AGE25_64) +\n    D_(SCHOOL_COUNT + \n         BUSINESS_COUNT +\n         RETAILS_COUNT +\n         FINSERV_COUNT) +\n    P_(log(DISTANCE + 1)),\n  spflow_networks = mpsz_multi_net\n)\n\nbase_model\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n--------------------------------------------------\nSpatial interaction model estimated by: MLE  \nSpatial correlation structure: SDM (model_9)\nDependent variable: log(1 + TRIPS)\n\n--------------------------------------------------\nCoefficients:\n                          est     sd   t.stat  p.val\nrho_d                   0.680  0.004  192.554  0.000\nrho_o                   0.678  0.004  187.733  0.000\nrho_w                  -0.396  0.006  -65.592  0.000\n(Intercept)             0.410  0.065    6.267  0.000\n(Intra)                 1.312  0.081   16.262  0.000\nD_SCHOOL_COUNT          0.017  0.002    7.885  0.000\nD_SCHOOL_COUNT.lag1     0.002  0.004    0.552  0.581\nD_BUSINESS_COUNT        0.000  0.000    3.015  0.003\nD_BUSINESS_COUNT.lag1   0.000  0.000   -0.249  0.804\nD_RETAILS_COUNT         0.000  0.000   -0.306  0.759\nD_RETAILS_COUNT.lag1    0.000  0.000    0.152  0.880\nD_FINSERV_COUNT         0.002  0.000    6.787  0.000\nD_FINSERV_COUNT.lag1   -0.002  0.001   -3.767  0.000\nO_BUSSTOP_COUNT         0.002  0.000    6.807  0.000\nO_BUSSTOP_COUNT.lag1   -0.001  0.000   -2.364  0.018\nO_AGE25_64              0.000  0.000    7.336  0.000\nO_AGE25_64.lag1         0.000  0.000   -2.797  0.005\nP_log(DISTANCE + 1)    -0.050  0.007   -6.794  0.000\n\n--------------------------------------------------\nR2_corr: 0.6942948  \nObservations: 97969  \nModel coherence: Validated\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncorr_residual <- pair_cor(base_model)\ncolnames(corr_residual) <- substr(colnames(corr_residual),1,3)\ncor_image(corr_residual)\n```\n\n::: {.cell-output-display}\n![](In-Class_Ex5_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n## Working with Model Control\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspflow_formula <- log(1+TRIPS) ~\n  O_(BUSSTOP_COUNT + AGE25_64) +\n  D_(SCHOOL_COUNT + \n       BUSINESS_COUNT +\n       RETAILS_COUNT +\n       FINSERV_COUNT) +\n  P_(log(DISTANCE + 1))\n\nmodel_control <- spflow_control(\n  estimation_method = 'mle',\n  model = \"model_8\"\n)\n\nmle_model8 <- spflow(\n  spflow_formula,\n  spflow_networks = mpsz_multi_net,\n  estimation_control = model_control\n)\n\nmle_model8\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n--------------------------------------------------\nSpatial interaction model estimated by: MLE  \nSpatial correlation structure: SDM (model_8)\nDependent variable: log(1 + TRIPS)\n\n--------------------------------------------------\nCoefficients:\n                          est     sd    t.stat  p.val\nrho_d                   0.689  0.003   196.832  0.000\nrho_o                   0.687  0.004   192.214  0.000\nrho_w                  -0.473  0.003  -142.469  0.000\n(Intercept)             1.086  0.049    22.275  0.000\n(Intra)                 0.840  0.075    11.255  0.000\nD_SCHOOL_COUNT          0.019  0.002     8.896  0.000\nD_SCHOOL_COUNT.lag1     0.019  0.004     5.130  0.000\nD_BUSINESS_COUNT        0.000  0.000     3.328  0.001\nD_BUSINESS_COUNT.lag1   0.000  0.000     1.664  0.096\nD_RETAILS_COUNT         0.000  0.000    -0.414  0.679\nD_RETAILS_COUNT.lag1    0.000  0.000    -0.171  0.864\nD_FINSERV_COUNT         0.002  0.000     6.150  0.000\nD_FINSERV_COUNT.lag1   -0.003  0.001    -4.601  0.000\nO_BUSSTOP_COUNT         0.003  0.000     7.676  0.000\nO_BUSSTOP_COUNT.lag1    0.000  0.000     0.552  0.581\nO_AGE25_64              0.000  0.000     6.870  0.000\nO_AGE25_64.lag1         0.000  0.000    -0.462  0.644\nP_log(DISTANCE + 1)    -0.125  0.005   -22.865  0.000\n\n--------------------------------------------------\nR2_corr: 0.6965974  \nObservations: 97969  \nModel coherence: Validated\n```\n:::\n:::\n",
    "supporting": [
      "In-Class_Ex5_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}